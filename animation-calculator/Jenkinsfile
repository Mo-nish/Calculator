pipeline {
    agent any

    environment {
        VENV_PATH = 'venv'
        SONARQUBE = 'Calculator' // Jenkins Sonar server name - must match Jenkins configuration
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Mo-nish/Calculator.git'
            }
        }

        stage('Setup Python Environment') {
            steps {
                bat """
                    python -m venv %VENV_PATH%
                    call %VENV_PATH%\\Scripts\\activate
                    pip install --upgrade pip
                    pip install -r animation-calculator\\backend\\requirements.txt pytest
                """
            }
        }

        stage('Run Tests') {
            steps {
                bat """
                    echo === Activating virtual environment ===
                    call %VENV_PATH%\\Scripts\\activate

                    echo === Running tests from correct directory ===
                    cd animation-calculator\\backend
                    pytest test_app.py -v --maxfail=1 --disable-warnings --junitxml=..\\..\\test-results.xml
                """
            }
            post {
                always {
                    bat 'dir animation-calculator\\backend'
                    junit 'test-results.xml'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE}") {
                    script {
                        // Check if sonar-scanner exists in PATH
                        def scannerExists = bat(
                            script: 'where sonar-scanner >nul 2>&1',
                            returnStatus: true
                        ) == 0
                        
                        def scannerCmd = 'sonar-scanner'
                        
                        if (!scannerExists) {
                            echo "⚠️ sonar-scanner not found in PATH. Setting up..."
                            bat """
                                if not exist sonar-scanner (
                                    echo Downloading SonarQube Scanner...
                                    powershell -Command "& {Invoke-WebRequest -Uri 'https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-windows.zip' -OutFile 'sonar-scanner.zip'; Expand-Archive -Path 'sonar-scanner.zip' -DestinationPath '.' -Force}"
                                    for /f "delims=" %%i in ('dir /b /ad sonar-scanner-* 2^>nul') do (
                                        move "%%i" sonar-scanner
                                    )
                                    del sonar-scanner.zip 2>nul
                                )
                            """
                            scannerCmd = "${WORKSPACE}\\sonar-scanner\\bin\\sonar-scanner.bat"
                        } else {
                            echo "✅ sonar-scanner found in PATH"
                        }
                        
                        // withSonarQubeEnv injects SONAR_HOST_URL and SONAR_TOKEN environment variables
                        // Access them via env object and pass explicitly to ensure they're used
                        def sonarHostUrl = env.SONAR_HOST_URL ?: ''
                        def sonarToken = env.SONAR_TOKEN ?: env.SONAR_LOGIN ?: ''
                        
                        if (!sonarToken) {
                            error "SonarQube authentication token not found. Please check SonarQube server configuration in Jenkins."
                        }
                        
                        echo "Using SonarQube server: ${sonarHostUrl}"
                        
                        // Run SonarQube analysis with explicit authentication
                        bat """
                            call %VENV_PATH%\\Scripts\\activate
                            "${scannerCmd}" -Dproject.settings=animation-calculator\\sonar-project.properties -Dsonar.host.url=${sonarHostUrl} -Dsonar.token=${sonarToken}
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "✅ Pipeline completed successfully!"
        }
        failure {
            echo "❌ Pipeline failed — check console output."
        }
    }
}
